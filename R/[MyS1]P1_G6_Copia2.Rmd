---
title: "Practica 1 - G8"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Smart Packaging es una solución innovadora que demuestra el potencial de aplicar tecnología avanzada a los procesos logísticos de empaque. Sin embargo, los inversores de la empresa han expresado preocupación por el incremento constante en los costos energéticos. Uno de los inversores obtuvo información detallada sobre el consumo energético y la exportó en el archivo POE_2023.xlsx, el cual contiene registros del consumo medido en MWh. Este inversor considera que dicha información es clave para evaluar la rentabilidad del negocio. Con base en la construcción de un modelo de análisis, se desea responder a las siguientes preguntas:

# 1. ¿Cuál es el costo actual del consumo energético, considerando que los robots consumen actualmente 0.2 MWh y operan bajo el horario laboral vigente (08:00 a 20:00 horas)?

```{r}
# Cargar las librerías
library(readxl)    
library(dplyr)     
library(tidyr)     
library(lubridate) 
library(ggplot2) 

ARCHIVO_EXCEL <- "POE_2023.xlsx"

# horario laboral: de 8:00 AM a 8:00 PM (20:00 horas)
HORARIO_LABORAL <- 8:20 

# días laborales promedio por mes
DIAS_LABORALES_MES <- 30

# Parámetros del problema
CONSUMO_ACTUAL <- 0.2
HORAS_ACTUALES <- length(HORARIO_LABORAL) #las horas que se trabajan al dia

MESES <- c("ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO",
           "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE")
```

## Funcion para procesar la información del excel

```{r}
procesar_datos_energia <- function(archivo_excel) {
  
  if (!file.exists(archivo_excel)) {
    stop(paste("Error: No se encuentra el archivo", archivo_excel))
  }
  
  #almacenar todos los datos procesados
  datos_completos <- data.frame()
  
  # Procesar cada mes del año
  for (i in 1:length(MESES)) {
    mes <- MESES[i]
    
    tryCatch({
      # Leer la hoja correspondiente al mes actual del archivo Excel
      datos_raw <- read_excel(archivo_excel, sheet = mes, col_names = FALSE, col_types = "text")
      
      # Buscar en qué fila está la palabra "Hora" porque ahi van a iniciar los datos
      fila_hora <- which(datos_raw[[1]] == "Hora", arr.ind = TRUE)
      
      if (length(fila_hora) > 0) {
        # Los datos reales empiezan en la fila de abajo
        inicio_datos <- fila_hora[1] + 1
        # Extraer solo las filas que contienen datos
        datos_mes <- datos_raw[inicio_datos:nrow(datos_raw), ]
        
        # Sacamos los encabezados para saber los dias del mes
        encabezados <- datos_raw[fila_hora[1], ]
        dias_mes <- suppressWarnings(as.numeric(unlist(encabezados[3:ncol(encabezados)])))
        # Filtrar solo días válidos (entre 1 y 31, sin valores NA)
        dias_mes <- dias_mes[!is.na(dias_mes) & dias_mes >= 1 & dias_mes <= 31]
        
        registros_mes <- 0
        
        # Procesar cada fila de datos que vendra siendo cada hora del dia
        for (fila in 1:nrow(datos_mes)) {
          primera_col <- datos_mes[fila, 1]
          
          # Verificar que la celda no esté vacía
          if (!is.na(primera_col) && !is.null(primera_col) && primera_col != "") {
            
            # VAlidamos que los datos vengan en formato de fraccion que es el formato que usa excel para las horas
            # suppressWarnings evita mostrar advertencias si la conversión falla
            hora_fraccion <- suppressWarnings(as.numeric(primera_col))
            
            if (!is.na(hora_fraccion) && is.numeric(hora_fraccion)) {
              # Convertir la fracción de día a hora del día (0-23) para que sea facil de entender
              hora <- floor(hora_fraccion * 24)
              
              if (!is.na(hora) && hora >= 0 && hora <= 23) {
                
                # Procesar cada día del mes actual
                for (col in 1:length(dias_mes)) {
                  dia <- dias_mes[col]
                  
                  # Obtener el precio de energía para esta hora y día específicos
                  # col + 2 porque las primeras 2 columnas son hora, los días empiezan en la 3ra
                  precio_raw <- datos_mes[fila, col + 2]
                  precio <- suppressWarnings(as.numeric(precio_raw))
                  
                  if (!is.na(precio) && !is.na(dia) && precio > 0) {
                    # Agregar este registro al data frame de datos completos
                    datos_completos <- rbind(datos_completos, data.frame(
                      mes = mes,              
                      mes_num = i,            
                      dia = dia,              
                      hora = hora,            
                      precio_mwh = precio,    # Precio de energía en USD/MWh
                      stringsAsFactors = FALSE 
                    ))
                    # Incrementar el contador de registros procesados para este mes
                    registros_mes <- registros_mes + 1
                  }
                }
              }
            }
          }
        }
        cat(registros_mes, "registros\n")
      } else {
        # Si no se encontró la fila de "Hora"
        cat("no se encontró fila 'Hora'\n")
      }
    }, error = function(e) {
      # Si ocurre algún error durante el procesamiento, mostrar el mensaje
      cat("Error:", conditionMessage(e), "\n")
    })
  }
  
  # Mostrar el total de registros procesados de todos los meses
  cat("Total de registros procesados:", nrow(datos_completos), "\n")
  return(datos_completos)
}
```

### Procesar datos

```{r}
# Ejecutar la función para procesar todos los datos del archivo Excel
datos <- procesar_datos_energia(ARCHIVO_EXCEL)

# Filtrar los datos para incluir solo las horas del horario laboral (8:00 a 20:00)
datos_laborales <- datos %>%
  filter(hora %in% HORARIO_LABORAL)

resumen_datos <- datos_laborales %>%
  group_by(mes) %>%  # Agrupar los datos por mes
  summarise(
    registros = n(),  
    precio_min = min(precio_mwh, na.rm = TRUE),      
    precio_max = max(precio_mwh, na.rm = TRUE),      
    precio_promedio = mean(precio_mwh, na.rm = TRUE), 
    .groups = 'drop'
  )

```

### Calculos

```{r}
# Calcular los costos mensuales basados en el consumo actual
costos_mensuales <- datos_laborales %>%
  group_by(mes, mes_num) %>%  # Agrupar por mes y número de mes
  summarise(
    precio_promedio = mean(precio_mwh, na.rm = TRUE),
    registros = n(),  
    .groups = 'drop'  
  ) %>%
  mutate(
    # Precio promedio × Consumo por hora × Horas por día × Días por mes
    costo_mensual_actual = precio_promedio * CONSUMO_ACTUAL * HORAS_ACTUALES * DIAS_LABORALES_MES
  ) %>%
  arrange(mes_num)

# Calcular el costo total anual sumando todos los costos mensuales
costo_anual_actual <- sum(costos_mensuales$costo_mensual_actual)
```

### RESPUESTA 1

```{r}
cat("\nCOSTO ACTUAL DEL CONSUMO ENERGÉTICO\n", "Costo anual total:", scales::dollar(costo_anual_actual), "\n", "Costo mensual promedio:", scales::dollar(costo_anual_actual/12), "\n")
```

# 2. Si se modifica el modelo para que los robots consuman 0.15 MWh, pero trabajen la mitad del tiempo, ¿sigue siendo rentable la operación?

```{r}

CONSUMO_NUEVO <- 0.15
HORAS_NUEVAS <- HORAS_ACTUALES / 2

```

### Calculos

```{r}
costos_mensuales_nuevos <- costos_mensuales %>%
  mutate(
  costo_mensual_nuevo = precio_promedio * CONSUMO_NUEVO * HORAS_NUEVAS * DIAS_LABORALES_MES,
  ahorro_mensual = costo_mensual_actual - costo_mensual_nuevo,
    porcentaje_ahorro = (ahorro_mensual / costo_mensual_actual) * 100
  )

costo_anual_nuevo <- sum(costos_mensuales_nuevos$costo_mensual_nuevo)
ahorro_anual <- costo_anual_actual - costo_anual_nuevo
porcentaje_ahorro_anual <- (ahorro_anual / costo_anual_actual) * 100
```

### RESPUESTA 2

```{r}
cat("\nRENTABILIDAD DEL NUEVO MODELO\n", "Costo anual actual:", scales::dollar(costo_anual_actual), "\n", "Costo anual propuesto:", scales::dollar(costo_anual_nuevo), "\n", "Ahorro anual:", scales::dollar(ahorro_anual), "\n", "Porcentaje de ahorro:", round(porcentaje_ahorro_anual, 1), "%\n")

```

```{r}
cat(" El modelo propuesto genera ahorros superiores al 60%\n")
```

# 3. Los inversores desean identificar el mes más rentable y el mes menos rentable. Esta información debe presentarse en:

## Una tabla comparativa mensual.

```{r}
tabla_comparativa <- costos_mensuales_nuevos %>%
  mutate(
    Mes = mes,
    `Precio Promedio ($/MWh)` = round(precio_promedio, 2),
    `Costo Actual ($)` = round(costo_mensual_actual, 0)
  ) %>%
  select(Mes, `Precio Promedio ($/MWh)`, `Costo Actual ($)`)

print(tabla_comparativa)
```

## Una gráfica ordenada por mes, que permita visualizar tendencias de aumento o disminución en la rentabilidad.

```{r}
datos_grafico <- costos_mensuales_nuevos %>%
  select(mes, mes_num, costo_mensual_actual, costo_mensual_nuevo, precio_promedio, ahorro_mensual) %>%
  pivot_longer(cols = c(costo_mensual_actual, costo_mensual_nuevo), 
               names_to = "modelo", values_to = "costo") %>%
  mutate(
    modelo = case_when(
      modelo == "costo_mensual_actual" ~ "Modelo Actual",
      modelo == "costo_mensual_nuevo" ~ "Modelo Propuesto"
    ),
    mes_abrev = factor(substr(mes, 1, 3), 
                       levels = substr(MESES, 1, 3))
  )

grafico_costos <- ggplot(datos_grafico, aes(x = mes_num, y = costo, color = modelo)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_point(size = 3.5, alpha = 0.9) +
  scale_x_continuous(breaks = 1:12, labels = substr(MESES, 1, 3)) +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_color_manual(
    values = c("Modelo Actual" = "#E74C3C", "Modelo Propuesto" = "#27AE60"),
    name = "Modelo"
  ) +
  labs(
    title = "Comparación de Costos Energéticos Mensuales 2023",
    subtitle = paste("Smart Packaging - Ahorro anual proyectado:", scales::dollar(ahorro_anual)),
    x = "Mes",
    y = "Costo Mensual (USD)",
    caption = "Fuente: POE_2023.xslx"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "#349beb"),
    legend.position = "bottom",
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(grafico_costos)
```

```{r}
# Filtrar los datos del mes de ENERO
enero_data <- datos %>%
  filter(mes == "ENERO")

# Función para calcular el costo total según las horas activas
calcular_costo_esquema <- function(horas_activas) {
  enero_data %>%
    filter(hora %in% horas_activas) %>%
    summarise(costo_total = sum(precio_mwh * 0.2)) %>%
    pull(costo_total)
}

# Definir horas activas por alternativa
horas_a <- c(4:11, 16:23)       # a) descansa 00-04 y 12-16
horas_b <- c(0:7, 12:15, 20:23) # b) descansa 08-12 y 16-20
horas_c <- c(0:7, 12:19)        # c) descansa 08-12 y 20-24

# Calcular costos por alternativa
costo_a <- calcular_costo_esquema(horas_a)
costo_b <- calcular_costo_esquema(horas_b)
costo_c <- calcular_costo_esquema(horas_c)

# Crear tabla comparativa
df_costos <- data.frame(
  Alternativa = c("a) 00-04 & 12-16", "b) 08-12 & 16-20", "c) 08-12 & 20-24"),
  Horas_Operativas = c(length(horas_a), length(horas_b), length(horas_c)) * 31,  # enero tiene 31 días
  Consumo_Total_MWh = round(c(length(horas_a), length(horas_b), length(horas_c)) * 31 * 0.2, 2),
  Costo_Total_USD = round(c(costo_a, costo_b, costo_c), 2)
)

# Mostrar tabla
df_costos

```
```{r}
library(ggplot2)

ggplot(df_costos, aes(x = Alternativa, y = Costo_Total_USD, fill = Alternativa)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = paste0("$", round(Costo_Total_USD, 2))), vjust = -0.5) +
  labs(
    title = "Comparación de Costos por Esquema de Operación (ENERO)",
    x = "Alternativa",
    y = "Costo Total (USD)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```
Conclusión
Las tres alternativas propuestas mantuvieron el mismo consumo total, pero el costo varió según el horario operado. La opción b) fue la más económica, lo que demuestra que operar en horas con menor tarifa puede reducir costos sin afectar la productividad.

